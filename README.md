# سیستم مدیریت تسک

یک API RESTful قدرتمند و امن برای مدیریت تسک‌ها، ساخته شده با **Node.js**، **Express**، **Sequelize** و **MySQL**. این سیستم از احراز هویت کاربران، مدیریت پروفایل، مدیریت تسک‌ها و قابلیت‌های مدیریتی برای ادمین پشتیبانی می‌کند. همچنین شامل آپلود امن فایل، صفحه‌بندی (Pagination) و مدیریت خطاها به صورت جامع است. پروژه با رعایت اصول کد تمیز و بهترین شیوه‌ها نوشته شده تا مقیاس‌پذیر و قابل نگهداری باشد.

## فهرست مطالب
- [ویژگی‌ها](#ویژگی‌ها)
- [فناوری‌ها](#فناوری‌ها)
- [پیش‌نیازها](#پیش‌نیازها)
- [نصب](#نصب)
- [اجرای برنامه](#اجرای-برنامه)
- [ساختار پروژه](#ساختار-پروژه)
- [نقاط پایانی API](#نقاط-پایانی-api)
- [تست](#تست)
- [مدیریت خطاها](#مدیریت-خطاها)
- [امنیت](#امنیت)
- [مشارکت](#مشارکت)
- [مجوز](#مجوز)

## ویژگی‌ها
- **احراز هویت کاربران**:
  - ثبت‌نام با نام کاربری، ایمیل، شماره تلفن و رمز عبور (حداقل ۸ کاراکتر با حروف بزرگ و کوچک).
  - جلوگیری از ثبت‌نام با نام کاربری، ایمیل یا شماره تلفن تکراری.
  - ورود با نام کاربری و رمز عبور و دریافت توکن JWT.
  - کاربران به صورت پیش‌فرض نقش "کاربر عادی" دارند و تنها به مدیریت تسک‌ها و پروفایل دسترسی دارند.
- **مدیریت پروفایل**:
  - به‌روزرسانی ایمیل و شماره تلفن (نام کاربری غیرقابل تغییر است).
  - آپلود تصویر پروفایل (فرمت‌های JPEG، PNG، PDF؛ حداکثر ۵ مگابایت).
  - دانلود تصویر پروفایل.
  - تغییر امن رمز عبور.
- **مدیریت تسک‌ها**:
  - ایجاد، خواندن، به‌روزرسانی و حذف تسک‌ها با نام، توضیحات و پیوست اختیاری.
  - دانلود پیوست‌های تسک.
  - لیست تسک‌ها با پشتیبانی از صفحه‌بندی.
  - کاربران تنها به تسک‌های خودشان دسترسی دارند.
- **ویژگی‌های ادمین**:
  - دریافت لیست تمامی کاربران با صفحه‌بندی.
  - به‌روزرسانی اطلاعات کاربران (ایمیل و شماره تلفن).
  - تغییر نقش کاربران (کاربر عادی یا ادمین).
  - حذف کاربران و تسک‌های مرتبط با آن‌ها.
- **عمومی**:
  - ثبت تاریخ ایجاد و به‌روزرسانی برای همه موجودیت‌ها.
  - اعتبارسنجی جامع برای ایمیل، شماره تلفن و سایر فیلدها.
  - آپلود امن فایل‌ها با محدودیت نوع و اندازه.
  - پشتیبانی از صفحه‌بندی در APIهای دریافت لیست.
  - مدیریت متمرکز خطاها برای جلوگیری از خطای ۵۰۰.
  - احراز هویت مبتنی بر JWT و کنترل دسترسی مبتنی بر نقش.

## فناوری‌ها
- **Node.js** و **Express** (v4.21.2): فریم‌ورک بک‌اند برای ساخت API.
- **Sequelize** (v6.37.7): ORM برای تعامل با دیتابیس MySQL.
- **MySQL**: دیتابیس رابطه‌ای برای ذخیره‌سازی داده‌ها.
- **JWT (jsonwebtoken)** (v9.0.2): احراز هویت مبتنی بر توکن.
- **Bcrypt** (v6.0.0): رمزنگاری رمز عبور برای ذخیره‌سازی امن.
- **Multer** (v2.0.2): مدیریت آپلود فایل با اعتبارسنجی نوع و اندازه.
- **Winston** (v3.17.0): لاگ‌گیری برای دیباگ و مانیتورینگ.
- **Express-validator** (v7.2.1): اعتبارسنجی ورودی‌های API.
- **dotenv** (v17.2.1): مدیریت متغیرهای محیطی.
- **express-async-errors** (v3.1.1): مدیریت خطاهای غیرهمزمان.
- **file-type** (v21.0.0): شناسایی نوع فایل‌ها.
- **mysql2** (v3.14.3): درایور MySQL برای Node.js.
- **nodemon** (v3.1.10): ابزار توسعه برای راه‌اندازی مجدد خودکار سرور.

## پیش‌نیازها
- **Node.js** (نسخه ۱۶ یا بالاتر)
- **MySQL** (نسخه ۸ یا بالاتر)
- **Postman** (برای تست APIها)
- فایل `.env` با متغیرهای زیر:
  ```plaintext
  PORT=5000
  DB_NAME=task_manager
  DB_USER=root
  DB_PASS=your_password
  DB_HOST=localhost
  DB_DIALECT=mysql
  JWT_SECRET=your_jwt_secret
  ```

## نصب
1. کلون کردن مخزن:
   ```bash
   git clone <repository-url>
   cd task-management-system
   ```
2. نصب وابستگی‌ها:
   ```bash
   npm install
   ```
3. تنظیم فایل `.env`:
   - فایل `.env.example` را کپی کرده و به `.env` تغییر نام دهید.
   - متغیرهای محیطی را با اطلاعات MySQL و راز JWT خود به‌روزرسانی کنید.
4. تنظیم دیتابیس MySQL:
   - یک دیتابیس به نام `task_manager` ایجاد کنید.
   - Sequelize به صورت خودکار طرح دیتابیس را در محیط غیر تولیدی همگام‌سازی می‌کند.

## اجرای برنامه
1. اجرای سرور توسعه:
   ```bash
   npm run dev
   ```
   این دستور از `nodemon` برای راه‌اندازی مجدد خودکار سرور در صورت تغییر کد استفاده می‌کند.
2. برای محیط تولید:
   ```bash
   npm start
   ```
3. سرور روی `http://localhost:5000` (یا پورت مشخص شده در `.env`) اجرا می‌شود.

## ساختار پروژه
```
task-management-system/
├── node_modules/          # وابستگی‌های پروژه
├── src/
│   ├── config/           # تنظیمات
│   │   ├── associations.js # ارتباط بین مدل‌های دیتابیس
│   │   └── db.js         # تنظیمات دیتابیس و راه‌اندازی Sequelize
│   ├── controllers/      # کنترلرها
│   │   ├── authController.js # ثبت‌نام و ورود کاربران
│   │   ├── profileController.js # مدیریت پروفایل
│   │   ├── taskController.js # عملیات CRUD تسک‌ها
│   │   └── userController.js # مدیریت کاربران توسط ادمین
│   ├── middleware/       # میدل‌ورها
│   │   ├── authorizeRoles.js # کنترل دسترسی مبتنی بر نقش
│   │   ├── errorMiddleware.js # مدیریت متمرکز خطاها
│   │   └── upload.js    # تنظیمات آپلود فایل با Multer
│   ├── models/           # مدل‌های دیتابیس
│   │   ├── taskModel.js # تعریف مدل تسک
│   │   └── userModel.js # تعریف مدل کاربر
│   ├── routes/           # مسیرها
│   │   ├── authRoutes.js # مسیرهای احراز هویت
│   │   ├── profileRoutes.js # مسیرهای پروفایل
│   │   ├── taskRoutes.js # مسیرهای تسک
│   │   └── userRoutes.js # مسیرهای مدیریت کاربران
│   ├── uploads/          # پوشه آپلود فایل‌ها
│   └── utils/            # ابزارها
│       ├── constants.js  # ثابت‌ها (نقش‌ها، نوع فایل‌ها و غیره)
│       ├── generateToken.js # تولید توکن JWT
│       ├── logger.js    # تنظیمات لاگ‌گیری با Winston
│       └── response.js  # ابزار پاسخ استاندارد API
│   └── app.js            # نقطه ورود اصلی برنامه
├── .env                  # متغیرهای محیطی
├── .gitignore            # فایل‌های نادیده گرفته شده توسط Git
├── combined.log          # لاگ‌های ترکیبی
├── error.log             # لاگ‌های خطاها
├── package-lock.json     # قفل وابستگی‌ها
├── package.json          # وابستگی‌ها و اسکریپت‌های پروژه
├── README.md             # مستندات پروژه
├── Task Management System.postman_collection.json # مجموعه تست Postman
└── TaskManagerEnv.postman_environment.json # محیط تست Postman
```

## نقاط پایانی API
لیست تمامی نقاط پایانی API در جدول زیر آمده است:

| روش | نقطه پایانی | توضیحات | دسترسی |
|------|--------------|---------|--------|
| POST | `/api/auth/register` | ثبت‌نام کاربر جدید با نام کاربری، ایمیل، شماره تلفن و رمز عبور | عمومی |
| POST | `/api/auth/login` | ورود با نام کاربری و رمز عبور و دریافت توکن JWT | عمومی |
| PUT | `/api/profile` | به‌روزرسانی ایمیل و شماره تلفن کاربر | احراز هویت شده |
| POST | `/api/profile/image` | آپلود تصویر پروفایل (JPEG، PNG، PDF؛ حداکثر ۵ مگابایت) | احراز هویت شده |
| GET | `/api/profile/download` | دانلود تصویر پروفایل کاربر | احراز هویت شده |
| PUT | `/api/profile/password` | تغییر رمز عبور کاربر | احراز هویت شده |
| POST | `/api/tasks` | ایجاد تسک با نام، توضیحات و پیوست اختیاری | احراز هویت شده |
| GET | `/api/tasks/:id` | دریافت تسک خاص با شناسه | احراز هویت شده |
| GET | `/api/tasks?page=1&limit=10` | دریافت لیست تسک‌های کاربر با صفحه‌بندی | احراز هویت شده |
| PUT | `/api/tasks/:id` | به‌روزرسانی نام، توضیحات یا پیوست تسک | احراز هویت شده |
| DELETE | `/api/tasks/:id` | حذف تسک و پیوست آن | احراز هویت شده |
| GET | `/api/tasks/:id/attachment` | دانلود پیوست تسک | احراز هویت شده |
| GET | `/api/users?page=1&limit=10` | دریافت لیست همه کاربران با صفحه‌بندی | ادمین |
| PUT | `/api/users/:id` | به‌روزرسانی ایمیل و شماره تلفن کاربر | ادمین |
| DELETE | `/api/users/:id` | حذف کاربر و تسک‌های مرتبط | ادمین |
| PATCH | `/api/users/:id/role` | تغییر نقش کاربر (کاربر عادی یا ادمین) | ادمین |

### احراز هویت
- اکثر نقاط پایانی نیاز به توکن JWT در هدر `Authorization` به صورت `Bearer <token>` دارند.
- نقاط پایانی مختص ادمین فقط برای کاربران با نقش `admin` قابل دسترسی هستند.

## تست
پروژه شامل یک مجموعه تست Postman (`Task Management System.postman_collection.json`) برای تست تمامی نقاط پایانی API است. این مجموعه موارد زیر را اعتبارسنجی می‌کند:
- کدهای وضعیت (مانند ۲۰۰، ۴۰۰، ۴۰۱، ۴۰۴).
- پیام‌های پاسخ (مانند "Task retrieved"، "User not found").
- یکپارچگی داده‌ها (مانند وجود فیلدهای مورد انتظار در پاسخ).

**نمونه تست Postman برای GET /api/tasks/:id:**
```javascript
pm.test('Task retrieved successfully', function () {
  pm.response.to.have.status(200);
  pm.expect(pm.response.json().message).to.equal('Task retrieved');
});
```

برای استفاده از مجموعه Postman:
1. فایل `Task Management System.postman_collection.json` را در Postman وارد کنید.
2. فایل محیط تست `TaskManagerEnv.postman_environment.json` را وارد کرده و متغیرها (مانند `baseUrl`، `token`) را تنظیم کنید.
3. مجموعه را اجرا کنید تا همه نقاط پایانی تست شوند.

## مدیریت خطاها
- تمام خطاها به صورت متمرکز در `errorMiddleware.js` مدیریت می‌شوند.
- خطاهای خاص (مانند اعتبارسنجی، مقادیر تکراری، انقضای توکن) با کدهای وضعیت مناسب (۴۰۰، ۴۰۱) و پیام‌های واضح پاسخ داده می‌شوند.
- خطاهای عمومی با کد ۴۰۰ و پیام کاربرپسند مدیریت می‌شوند.
- همه خطاها با استفاده از `winston` در فایل‌های `error.log` و `combined.log` ثبت می‌شوند.

## امنیت
- **احراز هویت**: مبتنی بر JWT با انقضای ۱ ساعته.
- **کنترل دسترسی**: مبتنی بر نقش (کاربر عادی و ادمین) با middleware `authorizeRoles`.
- **حفاظت از داده‌ها**: رمزهای عبور با `bcrypt` رمزنگاری می‌شوند.
- **ایزوله‌سازی تسک‌ها**: کاربران تنها به تسک‌های خودشان دسترسی دارند (بررسی `user_id`).
- **آپلود فایل**: محدود به فایل‌های JPEG، PNG و PDF با حداکثر اندازه ۵ مگابایت.
- **اعتبارسنجی ورودی**: اعتبارسنجی جامع با `express-validator` برای ایمیل، شماره تلفن، رمز عبور و فیلدهای تسک.

## مشارکت
1. مخزن را فورک کنید.
2. یک شاخه جدید برای ویژگی خود ایجاد کنید (`git checkout -b feature/YourFeature`).
3. تغییرات خود را کامیت کنید (`git commit -m 'Add YourFeature'`).
4. شاخه را به مخزن خود push کنید (`git push origin feature/YourFeature`).
5. یک درخواست pull ایجاد کنید.

## مجوز
این پروژه تحت مجوز MIT منتشر شده است.